<%= turbo_frame_tag :consistency_table do %>
  <% if @building_presenter.able_to_show_additional_tables? %>
    <h2 class="text-2xl font-bold mb-4">Consistency Table of Experts</h2>
    <p class="mb-4">Formula: 1 + (rating - min) * (defects_count - 1) / (max - min)</p>
    <table class="min-w-full border-collapse border border-gray-300 shadow-lg">
      <tr>
        <th class="border border-gray-300 p-4 bg-blue-100 font-bold text-blue-700 text-center">
          <p>Experts →</p>
          <p>Defects ↓</p>
        </th>
        <% @building_presenter.experts.each do |expert| %>
          <th class="border border-gray-300 p-4 text-center font-semibold"><%= expert.name %></th>
        <% end %>
        <th class="border border-gray-300 p-4 bg-blue-100 font-bold text-blue-700 text-center">Sum ↓</th>
        <th class="border border-gray-300 p-4 bg-blue-100 font-bold text-blue-700 text-center">Weight ↓</th>
        <th class="border border-gray-300 p-4 bg-blue-100 font-bold text-blue-700 text-center">Deviation ↓</th>
        <th class="border border-gray-300 p-4 bg-blue-100 font-bold text-blue-700 text-center">Squared Deviation ↓</th>
      </tr>

      <% @building_presenter.defects.each do |defect| %>
        <tr>
          <td class="border border-gray-300 p-4 text-center font-semibold"><%= defect.name %></td>
          <% @building_presenter.experts.each do |expert| %>
            <td class="border border-gray-300 p-4 text-center">
              <%= @building_presenter.consistency[[defect.id, expert.id]] %>
            </td>
          <% end %>
          <td class="border border-gray-300 p-4 text-center font-semibold bg-gray-100">
            <%= @building_presenter.consistency_sums[defect.id] %>
          </td>
          <td class="border border-gray-300 p-4 text-center font-semibold bg-green-100">
            <%= @building_presenter.weights[defect.id] %>
          </td>
          <td class="border border-gray-300 p-4 text-center font-semibold">
            <%= @building_presenter.deviations[defect.id] %>
          </td>
          <td class="border border-gray-300 p-4 text-center font-semibold">
            <%= @building_presenter.squared_deviations[defect.id] %>
          </td>
        </tr>
      <% end %>
    </table>

    <div class="mt-6 text-center">
      <div class="inline-block bg-blue-50 p-4 rounded-md shadow mb-4">
        <p class="text-lg font-semibold text-blue-700">Total Sum:</p>
        <p class="text-2xl font-bold text-blue-800"><%= @building_presenter.total_sum %></p>
      </div>
      <div class="inline-block bg-blue-50 p-4 rounded-md shadow">
        <p class="text-lg font-semibold text-blue-700">Average Sum:</p>
        <p class="text-2xl font-bold text-blue-800"><%= @building_presenter.average_sum %></p>
      </div>
      <div class="inline-block bg-blue-50 p-4 rounded-md shadow">
        <p class="text-lg font-semibold text-blue-700">Sum of Squared Deviations:</p>
        <p class="text-2xl font-bold text-blue-800"><%= @building_presenter.sum_of_squared_deviations %></p>
      </div>
    </div>
  <% end %>
<% end %>
